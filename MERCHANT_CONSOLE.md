# 商家控制台技术文档

## 概述

商家控制台是智能充电桩系统的管理后台，通过终端命令行界面为商家提供用户管理、余额操作等功能。系统采用非阻塞I/O和定时器机制，实现了与LVGL主循环的完美集成。

## 技术实现

### 1. 非阻塞终端I/O

系统使用Linux的`select()`和`fcntl()`系统调用实现非阻塞终端输入：

```c
// 设置stdin为非阻塞模式
int flags = fcntl(STDIN_FILENO, F_GETFL, 0);
fcntl(STDIN_FILENO, F_SETFL, flags | O_NONBLOCK);

// 使用select检查输入可用性
fd_set readfds;
struct timeval tv = {0, 0}; // 非阻塞
FD_ZERO(&readfds);
FD_SET(STDIN_FILENO, &readfds);

int result = select(STDIN_FILENO + 1, &readfds, NULL, NULL, &tv);
```

### 2. 定时器集成

控制台处理通过LVGL定时器机制集成到主事件循环：

```c
// 在Screen11界面创建100ms定时器
console_timer = lv_timer_create(console_timer_cb, 100, NULL);

// 定时器回调函数
static void console_timer_cb(lv_timer_t * timer) {
    merchant_console_process(); // 处理控制台命令
}
```

### 3. 命令解析系统

支持多种管理命令：

- **help**: 显示帮助信息
- **list**: 查看所有用户账号、密码、余额信息
- **balance <用户名>**: 查看指定用户的余额
- **set <用户名> <金额>**: 设置指定用户余额为指定数值
- **add <用户名> <金额>**: 为指定用户增加余额
- **exit**: 退出控制台

### 4. 用户数据管理

#### 文件格式
用户数据存储在文本文件中，格式为：
```
用户名:密码:余额
```

#### 数据操作
- **读取**: `get_all_users()` - 获取所有用户信息
- **更新**: `update_user_balance()` - 更新用户余额
- **查询**: `get_user_balance()` - 查询特定用户余额

### 5. 资源管理

#### 初始化
```c
bool merchant_console_init(void) {
    // 设置非阻塞I/O
    // 显示欢迎信息和帮助
    // 初始化命令缓冲区
}
```

#### 清理
```c
void merchant_console_stop(void) {
    // 恢复终端设置
    // 清理资源
}
```

#### 与UI集成
- Screen11进入时自动启动控制台
- Screen11退出时自动清理资源
- 支持Button38退出事件处理

## 安全特性

1. **权限控制**: 只有商家用户可以访问控制台功能
2. **输入验证**: 对所有用户输入进行格式和范围验证
3. **数据完整性**: 文件操作包含错误处理和数据校验
4. **并发安全**: 避免与主UI线程的数据竞争

## 使用示例

### 查看所有用户
```
请输入命令: list
=== 所有用户信息 ===
顾客用户:
  用户名: 123456, 密码: 123456, 余额: 100.00
  ...
商家用户:
  用户名: 666666, 密码: 666666, 余额: 100.00
```

### 余额管理
```
请输入命令: balance 11
用户 11 的余额: 100.00 元

请输入命令: set 11 200.00
成功设置用户 11 的余额为 200.00 元

请输入命令: add 11 50.00
成功为用户 11 充值 50.00 元，当前余额: 250.00 元
```

## 扩展性

系统设计支持轻松添加新的管理功能：

1. **添加新命令**: 在`merchant_console_process()`中添加新的命令处理逻辑
2. **数据操作**: 利用现有的用户认证API进行数据操作
3. **UI集成**: 通过定时器机制可以轻松与其他UI界面集成

## 故障排除

### 常见问题

1. **控制台无响应**
   - 检查是否在Screen11界面
   - 确认定时器是否正常创建
   - 检查终端权限

2. **命令不识别**
   - 确认命令格式正确
   - 检查参数数量和类型
   - 查看帮助信息确认可用命令

3. **用户数据异常**
   - 检查用户文件权限
   - 确认文件格式正确
   - 验证数据完整性

### 调试方法

1. 启用调试输出查看命令解析过程
2. 检查文件操作返回值
3. 使用printf跟踪程序执行流程
